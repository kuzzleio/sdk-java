os: linux
language: minimal
sudo: required

services:
  - docker

env:
  global:
    - AWS_S3_BUCKET=dl.kuzzle.io
    - TRAVIS_S3_BUCKET=travis-cache.kuzzle.io
    - AWS_CLOUDFRONT_DISTRIBUTION_ID=E12YL8EZVABYR0
    # BINTRAY_USER
    - secure: "LxONQZ8tHhxTqgu+kqx9fMCubCfTQHZsy/3ibE+l72xG8sOAYfj4hB5k1p4kklnv3skeFQEiL6B++B2qRITOEAPRdD8FExkc+UF/TM1rY5aUtjIjoA3uH4n9hYjHirTO5qNKf4KxDr1Zbcn4ISGebJ0EYwE0SG/ptrd06wPp1G8AHshc8XaZgen6gDaik66OWpQkOkmGsRz2EPmIBVgo7L2LGK21DSxE4/PTo+ou0WYCyxyyWSKLTLt1xZpt9LOtk7IckrHl+Nenl6IbV/CjHb3+5vwdifyFQd+K6AVe32iTIVjdxj7rDhEHYD0EqKb79ey+u8p9HquLnGH03gcVBeFQu/qhhQStsiwrD/S9c8jwBjWOOUnVI4bEbqjqxFaRlPfVnRaAjQZLRKHdqxyTJCdC2Ls79LmkqSCyTxM7WBwwgu4Slf6RJSbKJb5naHYlwDuKPbeyHLAYrxgjEHC28bxQiTr5wwBWxE9BLxUcnkFAXzsy3qE74FQOIjvQbtrruLIOGwRGRYtzyfygGA3MfTHug6JwZGngqFf3k+kbznE8fZe7zxMwT63P6/54rR5fU/plLoTNFqdQsZGAfGOSYuHIEzWXOkWxffqsOwxPa1VxQTLD32O95oBcrcvmw4toC2NeFTe/+zZRMfGMbu7QIi0AL3qFpky3j12zcyA/M2I="
    # BINTRAY_KEY
    - secure: "Iqn4ImAwFmQeoXXDb5JOsfcunSiSeLvdp4+AEsIeniMhpIk++ZJPDSxecC+NrvndTrxOXVqHEsFUfHnZYvPHMuvg9nhXvz/rmmyYH0hZqkKg2q2qM+Sz2UJBCvs6D1sJv3ZEVi8d6fVx5bbKXMzSE023XFBBK7l8nBsG5ObXBOzTzrus9UP+fk4FXif/QKJNcUSN7rLejUIxMCk36gMQYqYGiiqL3VE60aTpaUh7Vqj/8nCEPcO3K3gXTVybcGBcmsvinV5YEc+5s5ue8eX10ONY0oYF5GFd7aEsrKEFzT2d7MVq0a29cH1rWrxt6q7vXGZNKAdAQrDyRZUz9rMFtqH+2xOgagm22UiUYNlzrn2eDYRBd08X0y043gumdgmOq/CsyaI5bcUSKMr+rsZ2XIzBjefl8MU0xBhtKMO9g9WRfGBxjRbdg0ivRQoVGJbcUXTDl2WrLMgMjt8DT4nQP+PHdIV2FjZVNioqucqmEzfHIJt+hiw7EonGDnZ9uqkW6hm6b4JpGr5QF1yY6kKVCUQxLueUBAVdiZpULdevL7uYEUzdWIES2wTFE7LaWpHqnCOHYVpkIQpdole6+R0OhINhSHK0FW858xhZ2QGjtL1SSh5yzK4th6dpGKCiwMUSGSj5frpIeWPi+GqYoUQz+TvMGLGG2XGfihx74kQE0FA="
    - AWS_ACCESS_KEY_ID=AKIAIYAXFUAHXOWP2MJA
    # AWS_SECRET_ACCESS_KEY
    - secure: "dIcQzFpHKRf92cAiMA+SYsudtHWNcbYadVDb7zlJayWGUGy0i4CGwwOoOOrUcWgHxYhdN9XGwvFJTSswjHLRiHEyPFBwW8x/VfaCRS+jAcblMXyWNajvm0930S/3fRv5LA+4UKNmeXMuCGSf35ZqyEIEeuThkIomYvB/tBD1wcMpBUtQfmilLm3sUTaGUnFB651jBHshlYOZ8BAGLLmX1PAfT1wCrpVcrjq5kayNOIilJkwKGSr6q9C0p7+ULNZ4bHsATKLlYNs7Xcs+9a66p1EtKetP72DQsHrr8x3wB2Hhk3U425kmjIoE3gYnF7x3h3EpO5m0rGessbgdRF1SF7XK7Bsj4ukLb4HoktA8G7734ox4848RpH60aKUHRCsiebX7JKgJe1eEwU5BZK8+PFPGH6bI1YG1HQNqthzotTHFXu058uMHnyLv2PmDWWEYMM79fCyuRo8gJJ8GJhDgaGLgtizzEb6grcNW+QwunjA6nP4o7F9o+9b3lfGlsgL595V/CeWLNnHvENkSr67RN2NkDZm6q6EHbOk8AWtQc24mVawCwCbcJjp0sPkbQdCHUXSBNXjdwrvJLA3h94A2uVEmrV7mzMdfj+i9X3IS/HXRLeQk6Ivq2s/b1W6c7rBfz4zZUO7Uu5iYpVzT71yNFra13JkW3REFgHgETEvGkko="

addons:
  apt:
    packages:
      - python
      - python-pip

install:
  - pip install awscli --upgrade --user

stages:
  - name: Build & Tests
  - name: deploy
    if: type != pull_request

jobs:
  include:
    # ---------------------------------------------
    # OpenJDK 8: Build, test and deploy (only on master)
    # ---------------------------------------------
    # AMD64
    # ---------------------------------------------
    - stage: Build & Tests
      name: "Build & Tests with OpenJDK 8 - AMD64"

      before_install:
        - sudo sysctl -w vm.max_map_count=262144
        - ./.ci/start_kuzzle.sh

      script:
        - docker run --rm -it -e ARCH="amd64" --network ci_default --link kuzzle -v "$(pwd)":/mnt kuzzleio/sdk-cross:openjdk8 bash -c "make clean all && make test"

      after_success:
        - cd build && aws s3 cp . s3://$TRAVIS_S3_BUCKET/sdk-java/$TRAVIS_BUILD_NUMBER --recursive --exclude "*" --include "*.jar" --exclude "*/*"

    # ---------------------------------------------
    # I386
    # ---------------------------------------------
    - stage: Build & Tests
      name: "Build & Tests with OpenJDK 8 - i386"

      before_install:
        - sudo sysctl -w vm.max_map_count=262144
        - ./.ci/start_kuzzle.sh

      script:
        - docker run --rm -it -e ARCH="x86" --network ci_default --link kuzzle -v "$(pwd)":/mnt kuzzleio/sdk-cross:openjdk8-i386 bash -c "make clean all && make test"

      after_success:
        - cd build && aws s3 cp . s3://$TRAVIS_S3_BUCKET/sdk-java/$TRAVIS_BUILD_NUMBER --recursive --exclude "*" --include "*.jar" --exclude "*/*"

    # ---------------------------------------------
    # OpenJDK 9: Build & test
    # ---------------------------------------------
    # ---------------------------------------------
    # AMD64
    # ---------------------------------------------
    - stage: Build & Tests
      name: "Build & Tests with OpenJDK 9 - AMD64"

      before_install:
        - sudo sysctl -w vm.max_map_count=262144
        - ./.ci/start_kuzzle.sh

      script:
        - docker run --rm -it -e ARCH="amd64" --network ci_default --link kuzzle -v "$(pwd)":/mnt kuzzleio/sdk-cross:openjdk9 bash -c "make clean all && make test"

    # ---------------------------------------------
    # I386
    # ---------------------------------------------
    - stage: Build & Tests
      name: "Build & Tests with OpenJDK 9 - i386"

      before_install:
        - sudo sysctl -w vm.max_map_count=262144
        - ./.ci/start_kuzzle.sh

      script:
        - docker run --rm -it -e ARCH="x86" --network ci_default --link kuzzle -v "$(pwd)":/mnt kuzzleio/sdk-cross:openjdk9-i386 bash -c "make clean all && make test"

    # ---------------------------------------------
    # Oracle JDK 8: Build & test
    # ---------------------------------------------
    # AMD64
    # ---------------------------------------------
    - stage: Build & Tests
      name: "Build & Tests with Oracle JDK 8 - AMD64"

      before_install:
        - sudo sysctl -w vm.max_map_count=262144
        - ./.ci/start_kuzzle.sh

      script:
        - docker run --rm -it -e ARCH="amd64" --network ci_default --link kuzzle -v "$(pwd)":/mnt kuzzleio/sdk-cross:oracle8 bash -c "make clean all && make test"

    # ---------------------------------------------
    # I386
    # ---------------------------------------------
    - stage: Build & Tests
      name: "Build & Tests with Oracle JDK 8 - i386"

      before_install:
        - sudo sysctl -w vm.max_map_count=262144
        - ./.ci/start_kuzzle.sh

      script:
        - docker run --rm -it -e ARCH="x86" --network ci_default --link kuzzle -v "$(pwd)":/mnt kuzzleio/sdk-cross:oracle8-i386 bash -c "make clean all && make test"

    # ---------------------------------------------
    # Deploy on S3
    # ---------------------------------------------
    - stage: deploy
      name: "Deploy on S3"

      if: branch = master OR branch =~ ^.?-dev$

      script:
        - mkdir -p ./deploy
        - aws s3 sync s3://$TRAVIS_S3_BUCKET/sdk-java/$TRAVIS_BUILD_NUMBER ./deploy

      before_deploy:
        - |
          if [[ $TRAVIS_BRANCH =~ ^.?-dev$ ]]; then
            sudo mv ./deploy/kuzzlesdk-*-amd64-javadoc.jar ./deploy/kuzzlesdk-java-experimental-amd64-javadoc.jar;
            sudo mv ./deploy/kuzzlesdk-*-amd64-sources.jar ./deploy/kuzzlesdk-java-experimental-amd64-sources.jar;
            sudo mv ./deploy/kuzzlesdk-*-amd64.jar ./deploy/kuzzlesdk-java-experimental-amd64.jar;
            sudo mv ./deploy/kuzzlesdk-*-x86-javadoc.jar ./deploy/kuzzlesdk-java-experimental-x86-javadoc.jar;
            sudo mv ./deploy/kuzzlesdk-*-x86-sources.jar ./deploy/kuzzlesdk-java-experimental-x86-sources.jar;
            sudo mv ./deploy/kuzzlesdk-*-x86.jar ./deploy/kuzzlesdk-java-experimental-x86.jar;
          fi;

      deploy:
        provider: s3
        access_key_id: $AWS_ACCESS_KEY_ID
        secret_access_key: $AWS_SECRET_ACCESS_KEY
        bucket: $AWS_S3_BUCKET
        region: us-west-2
        skip_cleanup: true
        upload-dir: sdk/java/$TRAVIS_BRANCH
        local-dir: deploy
        on:
          all_branches: true

      after_deploy:
        - aws cloudfront create-invalidation --distribution-id $AWS_CLOUDFRONT_DISTRIBUTION_ID --paths "/*"

    # ---------------------------------------------
    # Deploy on Bintray
    # ---------------------------------------------
    - stage: deploy
      name: "Deploy on Bintray"

      if: branch = master

      script:
        - mkdir -p ./build/java/build/libs
        - aws s3 sync s3://$TRAVIS_S3_BUCKET/sdk-java/$TRAVIS_BUILD_NUMBER ./build/java/build/libs
        - cp ./build/java/build/libs/* ./build

      deploy:
        provider: script
        script:
          - docker run --rm -it -v "$(pwd)":/mnt kuzzleio/sdk-cross:openjdk8 bash -c "cd build/java && gradle bintrayUpload"
        skip_cleanup: true
        on:
          branch: master
    # ---------------------------------------------
    # Documentation
    # ---------------------------------------------
    - stage: Tests
      name: Dead link check
      if: type = pull_request OR type = push AND branch =~ /^master|[0-9]+-(dev|stable)$/ OR type = cron
      language: node_js
      node_js: 10

      before_script:
        - npm ci
        - npm run doc-prepare
        - $(npm bin)/kuzdoc iterate-repos:install --repos_path doc/framework/.repos/
        - $(npm bin)/kuzdoc framework:link -d /sdk/java/1/ -v 1
      script:
        - gem install typhoeus
        - cd doc/framework/ && HYDRA_MAX_CONCURRENCY=20 ruby .ci/dead-links.rb -p src/sdk/java/1/

    - stage: Deployment Doc Dev
      name: Deploy next-docs.kuzzle.io
      if: type = push AND branch =~ .*-dev
      language: node_js
      node_js: 10
      env:
        - BRANCH=dev
        - NODE_ENV=production
        - S3_BUCKET=docs-next.kuzzle.io
        - CLOUDFRONT_DISTRIBUTION_ID=E2ZCCEK9GRB49U
        - AWS_DEFAULT_REGION=us-west-2

      addons:
        apt:
          packages:
            - python
            - python-pip

      install:
        - pip install awscli --upgrade --user
        - npm ci

      script:
        - npm run doc-prepare
        - npm run doc-build

      deploy:
        provider: script
        script:
          - npm run doc-upload
        skip_cleanup: true

      after_deploy:
        - npm run doc-cloudfront

    - stage: Deployment Doc Prod
      name: Deploy docs.kuzzle.io
      if: type = push AND branch =~ /^master|[0-9]+-stable$/
      language: node_js
      node_js: 10
      env:
        - NODE_ENV=production
        - S3_BUCKET=docs.kuzzle.io
        - CLOUDFRONT_DISTRIBUTION_ID=E3D6RP0POLCJMM
        - AWS_DEFAULT_REGION=us-west-2

      addons:
        apt:
          packages:
            - python
            - python-pip

      install:
        - pip install awscli --upgrade --user
        - npm ci

      script:
        - npm run doc-prepare
        - npm run doc-build

      deploy:
        provider: script
        script:
          - npm run doc-upload
        skip_cleanup: true

      after_deploy:
        - npm run doc-cloudfront
